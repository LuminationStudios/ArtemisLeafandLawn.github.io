<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Artemis Lawn & Leaf</title>
  <link rel="stylesheet" href="theme.css">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js"></script>
  <style>
    /* Calendar container tweaks */
    #calendar { max-width: 1000px; margin: 24px auto; background: var(--card); border-radius: var(--radius); box-shadow: var(--glow); padding: 12px; }
    .top-actions { display:flex; gap:12px; justify-content:center; margin-bottom:8px; }
    .btn-small { padding:6px 10px; border-radius:10px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:#fff; font-weight:600; box-shadow:var(--glow); cursor:pointer; }
    .events-count { text-align:center; color:var(--muted); margin-top:4px; }
  </style>
</head>
<body>
  <header class="sticky-header">
    <div class="container header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">AL</div>
        <div>
          <h3 style="margin:0;color:var(--muted)">Artemis Lawn & Leaf</h3>
          <small style="color:#7c6b63">Admin Calendar</small>
        </div>
      </div>
      <nav class="nav-links">
        <a class="btn" href="index.html">Home</a>
        <a class="btn" href="book-schedule.html">Public Schedule</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <div class="top-actions">
      <button id="exportBtn" class="btn-small">Export JSON</button>
      <button id="importBtn" class="btn-small">Import JSON</button>
      <button id="clearBtn" class="btn-small" title="Remove all events">Clear All</button>
    </div>

    <div id="calendar"></div>
    <div class="events-count" id="eventsCount">Events: 0</div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <button class="close" id="closeModal">✕</button>
      <h3 id="modalTitle">Add Event</h3>
      <form id="eventForm">
        <label>Title</label>
        <input id="evTitle" required>
        <label>Date</label>
        <input id="evDate" type="date" required>
        <label>Start time</label>
        <input id="evStart" type="time">
        <label>End time</label>
        <input id="evEnd" type="time">
        <label>Description</label>
        <textarea id="evDesc" rows="3"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
          <button type="button" id="deleteEvent" style="background:#e36b2b;color:#fff;border-radius:10px;padding:8px 12px;display:none;">Delete</button>
          <button class="cta" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <footer>
    <p>© 2025 Artemis Lawn & Leaf</p>
    <p><a href="https://artielawnandleaf.com">Return to Main Site</a></p>
  </footer>

  <script>
    // LocalStorage key
    const STORAGE_KEY = 'artie_events_v1';

    // helpers
    function loadEventsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch(e){ console.error(e); return []; }
    }
    function saveEventsToStorage(events) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
      updateEventsCount();
    }
    function updateEventsCount(){ 
      const events = loadEventsFromStorage();
      document.getElementById('eventsCount').innerText = 'Events: ' + events.length;
    }

    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('modal');
      const closeModal = document.getElementById('closeModal');
      const eventForm = document.getElementById('eventForm');
      const deleteBtn = document.getElementById('deleteEvent');
      let editEventId = null;

      // init calendar
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        selectable: true,
        editable: true,
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
        dateClick: function(info) {
          openModalForDate(info.dateStr);
        },
        eventClick: function(info) {
          openModalForEdit(info.event);
        },
        eventDrop: function(info){ // update drop
          persistEventMove(info.event);
        },
        eventResize: function(info){ persistEventMove(info.event); }
      });
      calendar.render();

      // load stored events into calendar
      function renderStoredEvents(){
        const stored = loadEventsFromStorage();
        calendar.getEventSources().forEach(s => s.remove());
        calendar.addEventSource(stored.map(e => {
          return { id: e.id, title: e.title, start: e.start, end: e.end, extendedProps: { description: e.description } };
        }));
        updateEventsCount();
      }
      renderStoredEvents();

      // modal handlers
      function openModalForDate(dateStr){
        editEventId = null;
        document.getElementById('modalTitle').innerText = 'Add Event';
        document.getElementById('evTitle').value = '';
        document.getElementById('evDate').value = dateStr.slice(0,10);
        document.getElementById('evStart').value = '';
        document.getElementById('evEnd').value = '';
        document.getElementById('evDesc').value = '';
        deleteBtn.style.display = 'none';
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
      }
      function openModalForEdit(event){
        editEventId = event.id;
        document.getElementById('modalTitle').innerText = 'Edit Event';
        document.getElementById('evTitle').value = event.title || '';
        // set date and times
        const start = event.start;
        const end = event.end;
        document.getElementById('evDate').value = start.toISOString().slice(0,10);
        document.getElementById('evStart').value = start.toTimeString().slice(0,5);
        if(end){ document.getElementById('evEnd').value = end.toTimeString().slice(0,5); } else { document.getElementById('evEnd').value = ''; }
        document.getElementById('evDesc').value = event.extendedProps && event.extendedProps.description ? event.extendedProps.description : '';
        deleteBtn.style.display = 'inline-block';
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
      }

      closeModal.addEventListener('click',()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });
      document.getElementById('clearBtn').addEventListener('click',()=>{
        if(confirm('Clear all events? This cannot be undone.')){
          localStorage.removeItem(STORAGE_KEY);
          renderStoredEvents();
        }
      });

      // export
      document.getElementById('exportBtn').addEventListener('click',()=>{
        const data = loadEventsFromStorage();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'artie-events-' + (new Date()).toISOString().slice(0,10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
      });

      // import
      document.getElementById('importBtn').addEventListener('click',()=>{
        const input = document.createElement('input'); input.type='file'; input.accept='.json';
        input.onchange = e => {
          const file = e.target.files[0];
          if(!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            try {
              const parsed = JSON.parse(ev.target.result);
              if(Array.isArray(parsed)){
                saveEventsToStorage(parsed);
                renderStoredEvents();
                alert('Import successful!');
              } else alert('Invalid file format.');
            } catch(err){ alert('Failed to import: ' + err.message); }
          };
          reader.readAsText(file);
        };
        input.click();
      });

      // delete event button
      deleteBtn.addEventListener('click', ()=>{
        if(!editEventId) return;
        if(confirm('Delete this event?')){
          let events = loadEventsFromStorage();
          events = events.filter(e => e.id !== editEventId);
          saveEventsToStorage(events);
          modal.style.display='none'; modal.setAttribute('aria-hidden','true');
          renderStoredEvents();
        }
      });

      // form submit - create or update
      eventForm.addEventListener('submit', e => {
        e.preventDefault();
        const title = document.getElementById('evTitle').value.trim();
        const date = document.getElementById('evDate').value;
        const start = document.getElementById('evStart').value;
        const end = document.getElementById('evEnd').value;
        const desc = document.getElementById('evDesc').value.trim();
        if(!title || !date) { alert('Please provide title and date.'); return; }

        // build ISO strings
        const startISO = start ? new Date(date + 'T' + start).toISOString() : date;
        const endISO = end ? new Date(date + 'T' + end).toISOString() : (start ? new Date(date + 'T' + start).toISOString() : null);

        let events = loadEventsFromStorage();

        if(editEventId){
          // update existing
          events = events.map(ev => {
            if(ev.id === editEventId){
              return { ...ev, title, start: startISO, end: endISO, description: desc };
            }
            return ev;
          });
        } else {
          const id = 'e-' + Date.now();
          events.push({ id, title, start: startISO, end: endISO, description: desc });
        }

        saveEventsToStorage(events);
        renderStoredEvents();
        modal.style.display='none'; modal.setAttribute('aria-hidden','true');
      });

      // persist moves/resizes
      function persistEventMove(ev){
        const id = ev.id;
        let events = loadEventsFromStorage();
        events = events.map(e => {
          if(e.id === id){
            return { ...e, start: ev.start.toISOString(), end: ev.end ? ev.end.toISOString() : null };
          }
          return e;
        });
        saveEventsToStorage(events);
      }

    });
  </script>
</body>
</html>